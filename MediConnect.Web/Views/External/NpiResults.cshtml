@model MediConnect.Web.Models.NpiResultsPageVM
@{
    ViewData["Title"] = "NPI Lookup Results";
    Layout = "_Layout";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">@ViewData["Title"]</h2>
        <div class="d-flex">
            <a asp-action="NpiSearch" class="btn btn-outline-secondary me-2">‚Üê New Search</a>

            <!-- Route to full visualizations page with current filters -->
            <a asp-controller="External" asp-action="NpiVisualize"
               asp-route-FirstName="@Model.FirstName"
               asp-route-LastName="@Model.LastName"
               asp-route-Organization="@Model.Organization"
               asp-route-State="@Model.State"
               asp-route-City="@Model.City"
               asp-route-Taxonomy="@Model.Taxonomy"
               class="btn btn-primary">üìä View Visualizations</a>
        </div>
    </div>

    @if (Model.Rows == null || !Model.Rows.Any())
    {
        <div class="alert alert-warning">No results found. Try a broader search.</div>
    }
    else
    {
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Search Summary</h5>
                <ul class="list-group list-group-flush">
                    @if (!string.IsNullOrEmpty(Model.FirstName) || !string.IsNullOrEmpty(Model.LastName))
                    {
                        <li class="list-group-item"><strong>Name:</strong> @Model.FirstName @Model.LastName</li>
                    }
                    @if (!string.IsNullOrEmpty(Model.Organization))
                    {
                        <li class="list-group-item"><strong>Organization:</strong> @Model.Organization</li>
                    }
                    @if (!string.IsNullOrEmpty(Model.City))
                    {
                        <li class="list-group-item"><strong>City:</strong> @Model.City</li>
                    }
                    @if (!string.IsNullOrEmpty(Model.State))
                    {
                        <li class="list-group-item"><strong>State:</strong> @Model.State</li>
                    }
                    @if (!string.IsNullOrEmpty(Model.Taxonomy))
                    {
                        <li class="list-group-item"><strong>Taxonomy:</strong> @Model.Taxonomy</li>
                    }
                </ul>
            </div>
        </div>

        <div class="table-responsive mb-5">
            <table class="table table-striped table-hover align-middle shadow-sm">
                <thead class="table-primary">
                    <tr>
                        <th>NPI</th>
                        <th>Name</th>
                        <th>Specialty</th>
                        <th>City</th>
                        <th>State</th>
                        <th>Phone</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var r in Model.Rows)
                    {
                        <tr>
                            <td>@r.Npi</td>
                            <td>@r.Name</td>
                            <td>@r.PrimaryTaxonomy</td>
                            <td>@r.City</td>
                            <td>@r.State</td>
                            <td>@r.Phone</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    <hr class="my-5" />

    <!-- Inline charts (no gender) -->
    <a id="viz"></a>
    <div class="row g-4">
        <div class="col-xl-4 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-light fw-bold">Providers by State</div>
                <div class="card-body" style="height:340px;">
                    <canvas id="stateChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-light fw-bold">Top Specialties</div>
                <div class="card-body" style="height:340px;">
                    <canvas id="specChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-light fw-bold">Top Cities</div>
                <div class="card-body" style="height:340px;">
                    <canvas id="cityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
  const commonOpts = { responsive: true, maintainAspectRatio: false };

  const stateLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.StateLabels));
  const stateValues = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.StateValues));
  const specLabels  = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.SpecLabels));
  const specValues  = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.SpecValues));
  const cityLabels  = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.CityLabels));
  const cityValues  = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.CityValues));

  if (stateLabels.length) {
    new Chart(document.getElementById('stateChart'), {
      type: 'bar',
      data: { labels: stateLabels, datasets: [{ label: 'Providers', data: stateValues }] },
      options: { ...commonOpts, scales: { y: { beginAtZero: true } } }
    });
  }

  if (specLabels.length) {
    new Chart(document.getElementById('specChart'), {
      type: 'doughnut',
      data: { labels: specLabels, datasets: [{ data: specValues }] },
      options: { ...commonOpts, plugins: { legend: { position: 'bottom' } } }
    });
  }

  if (cityLabels.length) {
    new Chart(document.getElementById('cityChart'), {
      type: 'bar',
      data: { labels: cityLabels, datasets: [{ label: 'Providers', data: cityValues }] },
      options: { ...commonOpts, scales: { y: { beginAtZero: true } } }
    });
  }
</script>
